#!/bin/sh

# TDD Pre-commit Hook
# Ensures code quality and test coverage before commits

echo "üß™ Running TDD pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "${RED}‚ùå Docker is not running. Please start Docker.${NC}"
    exit 1
fi

# Check if containers are up
if ! docker-compose ps | grep -q "Up"; then
    echo "${YELLOW}‚ö†Ô∏è  Starting Docker containers...${NC}"
    docker-compose up -d
    sleep 10
fi

echo "${YELLOW}üîß Running code formatting...${NC}"
make pint

echo "${YELLOW}üîç Running static analysis...${NC}"
if ! make phpstan; then
    echo "${RED}‚ùå PHPStan analysis failed! Commit rejected.${NC}"
    echo "${YELLOW}üí° Fix PHPStan errors before committing.${NC}"
    echo "   Run: make phpstan (to see errors)"
    exit 1
fi

echo "${YELLOW}üß™ Running tests...${NC}"
if ! make test; then
    echo "${RED}‚ùå Tests failed! Commit rejected.${NC}"
    echo "${YELLOW}üí° Fix failing tests before committing.${NC}"
    echo "   Run: make tdd (for interactive mode)"
    echo "   Or:  make test (to see failures)"
    exit 1
fi

echo "${YELLOW}üìä Checking test coverage...${NC}"
if ! make test-coverage > /tmp/coverage.log 2>&1; then
    echo "${RED}‚ùå Coverage check failed!${NC}"
    cat /tmp/coverage.log
    exit 1
fi

# Extract coverage percentage from output
COVERAGE=$(grep -o "[0-9]\+\.[0-9]\+%" /tmp/coverage.log | tail -1 | sed 's/%//')

# Check if coverage meets minimum requirement (80%)
if [ -n "$COVERAGE" ] && [ $(echo "$COVERAGE < 80" | bc -l) -eq 1 ]; then
    echo "${RED}‚ùå Test coverage is too low: ${COVERAGE}%${NC}"
    echo "${YELLOW}üí° Minimum required coverage: 80%${NC}"
    echo "   Add more tests to increase coverage."
    exit 1
fi

echo "${GREEN}‚úÖ All TDD checks passed!${NC}"
echo "${GREEN}üìä Test coverage: ${COVERAGE:-"N/A"}%${NC}"
echo "${GREEN}üöÄ Proceeding with commit...${NC}"

exit 0